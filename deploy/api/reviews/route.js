"use strict";(()=>{var e={};e.id=186,e.ids=[186],e.modules={11185:e=>{e.exports=require("mongoose")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},40315:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>x,patchFetch:()=>q,requestAsyncStorage:()=>f,routeModule:()=>v,serverHooks:()=>w,staticGenerationAsyncStorage:()=>S});var i={};t.r(i),t.d(i,{GET:()=>y,POST:()=>g});var n=t(49303),a=t(88716),s=t(60670),o=t(87070),d=t(75571),u=t(90455),p=t(2021),l=t(27401),c=t(90149),m=t(43863);async function g(e){try{let r=await (0,d.getServerSession)(u.L);if(!r)return o.NextResponse.json({error:"Authentication required"},{status:401});let{target:t,targetType:i,rating:n,title:a,content:s,images:g}=await e.json();if(!t||!i||!n||!s)return o.NextResponse.json({error:"Missing required fields"},{status:400});if(n<1||n>5)return o.NextResponse.json({error:"Rating must be between 1 and 5"},{status:400});await (0,p.Z)();let y="Attraction"===i?c.Z:m.Z;if(!await y.findById(t))return o.NextResponse.json({error:"Target not found"},{status:404});if(await l.Z.findOne({user:r.user.id,target:t,targetType:i}))return o.NextResponse.json({error:"You have already reviewed this item"},{status:400});let v=await l.Z.create({user:r.user.id,target:t,targetType:i,rating:n,title:a,content:s,images:g||[]}),f=await l.Z.find({target:t,targetType:i,isApproved:!0}),S=f.reduce((e,r)=>e+r.rating,0)/f.length;await y.findByIdAndUpdate(t,{rating:Math.round(10*S)/10,reviewCount:f.length});let w=await l.Z.findById(v._id).populate("user","name image");return o.NextResponse.json(w,{status:201})}catch(e){return console.error("Error creating review:",e),o.NextResponse.json({error:"Internal server error"},{status:500})}}async function y(e){try{await (0,p.Z)();let{searchParams:r}=new URL(e.url),t=r.get("target"),i=r.get("targetType"),n=parseInt(r.get("page")||"1"),a=parseInt(r.get("limit")||"10");if(!t||!i)return o.NextResponse.json({error:"Target and targetType are required"},{status:400});let s=(n-1)*a,[d,u]=await Promise.all([l.Z.find({target:t,targetType:i,isApproved:!0}).populate("user","name image").populate("replies.user","name image").sort({createdAt:-1}).skip(s).limit(a),l.Z.countDocuments({target:t,targetType:i,isApproved:!0})]);return o.NextResponse.json({reviews:d,pagination:{page:n,limit:a,total:u,pages:Math.ceil(u/a)}})}catch(e){return console.error("Error fetching reviews:",e),o.NextResponse.json({error:"Internal server error"},{status:500})}}let v=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/reviews/route",pathname:"/api/reviews",filename:"route",bundlePath:"app/api/reviews/route"},resolvedPagePath:"/Users/luxiang/Cursor/AI-project/travel-to-china/app/api/reviews/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:f,staticGenerationAsyncStorage:S,serverHooks:w}=v,x="/api/reviews/route";function q(){return(0,s.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:S})}},90455:(e,r,t)=>{t.d(r,{L:()=>p});var i=t(53797),n=t(24459),a=t(12055),s=t(42023),o=t.n(s),d=t(2021),u=t(71732);let p={providers:[(0,i.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;await (0,d.Z)();let r=await u.Z.findOne({email:e.email});if(!r||!r.password||!await o().compare(e.password,r.password))return null;if(!r.isActive)throw Error("Account is disabled");return{id:r._id.toString(),email:r.email,name:r.name,image:r.image,role:r.role}}}),(0,n.Z)({clientId:process.env.FACEBOOK_CLIENT_ID,clientSecret:process.env.FACEBOOK_CLIENT_SECRET}),(0,a.ZP)({clientId:process.env.TWITTER_CLIENT_ID,clientSecret:process.env.TWITTER_CLIENT_SECRET,version:"2.0"})],callbacks:{async signIn({user:e,account:r,profile:t}){if(r?.provider==="credentials")return!0;if(r?.provider&&["facebook","twitter"].includes(r.provider)){await (0,d.Z)();let t=await u.Z.findOne({$or:[{email:e.email},{provider:r.provider,providerId:r.providerAccountId}]});t?(t.name=e.name||t.name,t.image=e.image||t.image,t.provider=r.provider,t.providerId=r.providerAccountId,await t.save()):await u.Z.create({name:e.name,email:e.email,image:e.image,provider:r.provider,providerId:r.providerAccountId,emailVerified:new Date})}return!0},jwt:async({token:e,user:r})=>(r&&(e.role=r.role),e),session:async({session:e,token:r})=>(e.user&&(e.user.id=r.sub,e.user.role=r.role),e)},pages:{signIn:"/auth/signin"},session:{strategy:"jwt"}}},2021:(e,r,t)=>{t.d(r,{Z:()=>o});var i=t(11185),n=t.n(i);let a=process.env.MONGODB_URI;if(!a)throw Error("Please define the MONGODB_URI environment variable inside .env.local");let s=global.mongoose;s||(s=global.mongoose={conn:null,promise:null});let o=async function(){if(s.conn)return s.conn;s.promise||(s.promise=n().connect(a,{bufferCommands:!1}).then(e=>e));try{s.conn=await s.promise}catch(e){throw s.promise=null,e}return s.conn}},90149:(e,r,t)=>{t.d(r,{Z:()=>s});var i=t(11185),n=t.n(i);let a=new i.Schema({name:{type:Map,of:String,required:!0},description:{type:Map,of:String,required:!0},location:{city:{type:String,required:!0},province:{type:String,required:!0},coordinates:{lat:{type:Number,required:!0},lng:{type:Number,required:!0}}},images:[{type:String,required:!0}],category:{type:String,enum:["historical","natural","cultural","modern","religious"],required:!0},rating:{type:Number,min:0,max:5,default:0},reviewCount:{type:Number,default:0},highlights:[String],ticketPrice:{adult:{type:Number,required:!0},child:{type:Number,required:!0},currency:{type:String,default:"CNY"}},duration:{type:String,required:!0},bestTimeToVisit:[String],openingHours:{open:{type:String,required:!0},close:{type:String,required:!0},note:String},contact:{phone:String,website:String,email:String},isActive:{type:Boolean,default:!0}},{timestamps:!0});a.index({"location.city":1}),a.index({category:1}),a.index({rating:-1}),a.index({"location.coordinates":"2dsphere"});let s=n().models.Attraction||n().model("Attraction",a)},43863:(e,r,t)=>{t.d(r,{Z:()=>s});var i=t(11185),n=t.n(i);let a=new i.Schema({title:{type:Map,of:String,required:!0},content:{type:Map,of:String,required:!0},excerpt:{type:Map,of:String,required:!0},author:{type:i.Schema.Types.ObjectId,ref:"User",required:!0},category:{type:String,enum:["first-time","food-culture","adventure","multi-city","budget","luxury"],required:!0},tags:[String],coverImage:{type:String,required:!0},images:[String],readTime:{type:Number,required:!0},views:{type:Number,default:0},likes:{type:Number,default:0},isPublished:{type:Boolean,default:!1},publishedAt:Date,itinerary:[{day:{type:Number,required:!0},title:{type:String,required:!0},description:{type:String,required:!0},activities:[String],accommodation:String,transportation:String,estimatedCost:Number}],relatedAttractions:[{type:i.Schema.Types.ObjectId,ref:"Attraction"}],seo:{metaTitle:String,metaDescription:String,keywords:[String]}},{timestamps:!0});a.index({category:1}),a.index({isPublished:1}),a.index({publishedAt:-1}),a.index({views:-1}),a.index({tags:1});let s=n().models.Guide||n().model("Guide",a)},27401:(e,r,t)=>{t.d(r,{Z:()=>s});var i=t(11185),n=t.n(i);let a=new i.Schema({user:{type:i.Schema.Types.ObjectId,ref:"User",required:!0},target:{type:i.Schema.Types.ObjectId,required:!0,refPath:"targetType"},targetType:{type:String,enum:["Attraction","Guide"],required:!0},rating:{type:Number,min:1,max:5,required:!0},title:String,content:{type:String,required:!0,maxlength:2e3},images:[String],likes:{type:Number,default:0},replies:[{user:{type:i.Schema.Types.ObjectId,ref:"User",required:!0},content:{type:String,required:!0,maxlength:500},createdAt:{type:Date,default:Date.now}}],isVerified:{type:Boolean,default:!1},isApproved:{type:Boolean,default:!0}},{timestamps:!0});a.index({target:1,targetType:1}),a.index({user:1}),a.index({rating:-1}),a.index({createdAt:-1});let s=n().models.Review||n().model("Review",a)},71732:(e,r,t)=>{t.d(r,{Z:()=>s});var i=t(11185),n=t.n(i);let a=new i.Schema({name:{type:String,required:!0,trim:!0},email:{type:String,required:!0,unique:!0,lowercase:!0,trim:!0},password:{type:String,required:function(){return"credentials"===this.provider}},image:{type:String},provider:{type:String,enum:["credentials","facebook","twitter"],default:"credentials"},providerId:{type:String},role:{type:String,enum:["user","admin"],default:"user"},isActive:{type:Boolean,default:!0},emailVerified:{type:Date},verificationToken:{type:String},resetPasswordToken:{type:String},resetPasswordExpires:{type:Date}},{timestamps:!0});a.index({email:1}),a.index({provider:1,providerId:1});let s=n().models.User||n().model("User",a)}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),i=r.X(0,[276,972,23,242],()=>t(40315));module.exports=i})();