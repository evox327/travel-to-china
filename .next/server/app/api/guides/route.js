"use strict";(()=>{var e={};e.id=264,e.ids=[264],e.modules={11185:e=>{e.exports=require("mongoose")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},32475:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>x,patchFetch:()=>S,requestAsyncStorage:()=>d,routeModule:()=>g,serverHooks:()=>y,staticGenerationAsyncStorage:()=>m});var a={};r.r(a),r.d(a,{GET:()=>h,POST:()=>p});var i=r(49303),s=r(88716),n=r(60670),o=r(87070),c=r(2021),l=r(43863),u=r(46643);async function h(e){try{let{searchParams:t}=new URL(e.url),r=parseInt(t.get("page")||"1"),a=parseInt(t.get("limit")||"12"),i=t.get("category"),s=t.get("search"),n=t.get("sort")||"newest",h=u.kx.generateKey("guides",r.toString(),a.toString(),i||"all",s||"none",n),p=await u.I5.get(h);if(p)return o.NextResponse.json(p);await (0,c.Z)();let g={isPublished:!0};i&&"all"!==i&&(g.category=i),s&&(g.$or=[{"title.en":{$regex:s,$options:"i"}},{"title.zh":{$regex:s,$options:"i"}},{"excerpt.en":{$regex:s,$options:"i"}},{"excerpt.zh":{$regex:s,$options:"i"}},{tags:{$in:[RegExp(s,"i")]}}]);let d={};switch(n){case"newest":default:d={publishedAt:-1};break;case"popular":d={views:-1};break;case"likes":d={likes:-1}}let m=(r-1)*a,[y,x]=await Promise.all([l.Z.find(g).populate("author","name image").sort(d).skip(m).limit(a).lean(),l.Z.countDocuments(g)]),S={guides:y,pagination:{page:r,limit:a,total:x,pages:Math.ceil(x/a)}};return await u.I5.set(h,S,3e5),o.NextResponse.json(S)}catch(e){return console.error("Error fetching guides:",e),o.NextResponse.json({error:"Internal server error"},{status:500})}}async function p(e){try{let t=await e.json();await (0,c.Z)();let r=await l.Z.create(t);return o.NextResponse.json(r,{status:201})}catch(e){return console.error("Error creating guide:",e),o.NextResponse.json({error:"Internal server error"},{status:500})}}let g=new i.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/guides/route",pathname:"/api/guides",filename:"route",bundlePath:"app/api/guides/route"},resolvedPagePath:"/Users/luxiang/Cursor/AI-project/travel-to-china/app/api/guides/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:d,staticGenerationAsyncStorage:m,serverHooks:y}=g,x="/api/guides/route";function S(){return(0,n.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:m})}},46643:(e,t,r)=>{r.d(t,{I5:()=>n,kx:()=>o});class a{constructor(e={}){this.cache=new Map,this.maxSize=e.maxSize||100,this.defaultTTL=e.ttl||3e5}set(e,t,r){let a=Date.now()+(r||this.defaultTTL);if(this.cache.size>=this.maxSize){let e=this.cache.keys().next().value;e&&this.cache.delete(e)}this.cache.set(e,{data:t,timestamp:Date.now(),expiry:a})}get(e){let t=this.cache.get(e);return t?Date.now()>t.expiry?(this.cache.delete(e),null):t.data:null}has(e){let t=this.cache.get(e);return!!t&&(!(Date.now()>t.expiry)||(this.cache.delete(e),!1))}delete(e){return this.cache.delete(e)}clear(){this.cache.clear()}size(){return this.cleanExpired(),this.cache.size}cleanExpired(){let e=Date.now(),t=[];this.cache.forEach((r,a)=>{e>r.expiry&&t.push(a)}),t.forEach(e=>this.cache.delete(e))}getStats(){return this.cleanExpired(),{size:this.cache.size,maxSize:this.maxSize,hitRate:0}}}class i{constructor(e="app_cache_",t=18e5){this.prefix=e,this.defaultTTL=t}set(e,t,r){try{let a=Date.now()+(r||this.defaultTTL),i={data:t,timestamp:Date.now(),expiry:a};localStorage.setItem(this.prefix+e,JSON.stringify(i))}catch(e){console.warn("Failed to set localStorage cache:",e)}}get(e){try{let t=localStorage.getItem(this.prefix+e);if(!t)return null;let r=JSON.parse(t);if(Date.now()>r.expiry)return localStorage.removeItem(this.prefix+e),null;return r.data}catch(e){return console.warn("Failed to get localStorage cache:",e),null}}has(e){return null!==this.get(e)}delete(e){try{return localStorage.removeItem(this.prefix+e),!0}catch(e){return console.warn("Failed to delete localStorage cache:",e),!1}}clear(){try{Object.keys(localStorage).filter(e=>e.startsWith(this.prefix)).forEach(e=>localStorage.removeItem(e))}catch(e){console.warn("Failed to clear localStorage cache:",e)}}cleanup(){try{Object.keys(localStorage).filter(e=>e.startsWith(this.prefix)).forEach(e=>{let t=localStorage.getItem(e);if(t)try{let r=JSON.parse(t);Date.now()>r.expiry&&localStorage.removeItem(e)}catch{localStorage.removeItem(e)}})}catch(e){console.warn("Failed to cleanup localStorage cache:",e)}}}class s{constructor(e={}){this.memoryCache=new a({maxSize:e.maxSize||50,ttl:e.ttl||3e5}),this.storageCache=new i("travel_cache_",e.ttl||18e5)}async get(e){let t=this.memoryCache.get(e);return t||((t=this.storageCache.get(e))?(this.memoryCache.set(e,t,3e5),t):null)}async set(e,t,r){this.memoryCache.set(e,t,Math.min(r||3e5,3e5)),this.storageCache.set(e,t,r||18e5)}async has(e){return this.memoryCache.has(e)||this.storageCache.has(e)}async delete(e){let t=this.memoryCache.delete(e),r=this.storageCache.delete(e);return t||r}async clear(){this.memoryCache.clear(),this.storageCache.clear()}cleanup(){this.storageCache.cleanup()}getStats(){return{memory:this.memoryCache.getStats(),storage:{size:0,hitRate:0}}}}let n=function(e="multi",t={}){switch(e){case"memory":return new a(t);case"storage":return new i("travel_cache_",t.ttl);default:return new s(t)}}("multi",{ttl:6e5,maxSize:100}),o={generateKey:(...e)=>e.map(e=>String(e)).join(":"),withCache:(e,t,r)=>async(...a)=>{let i=t(...a),s=await n.get(i);if(null!==s)return s;let o=await e(...a);return await n.set(i,o,r),o}}},2021:(e,t,r)=>{r.d(t,{Z:()=>o});var a=r(11185),i=r.n(a);let s=process.env.MONGODB_URI;if(!s)throw Error("Please define the MONGODB_URI environment variable inside .env.local");let n=global.mongoose;n||(n=global.mongoose={conn:null,promise:null});let o=async function(){if(n.conn)return n.conn;n.promise||(n.promise=i().connect(s,{bufferCommands:!1}).then(e=>e));try{n.conn=await n.promise}catch(e){throw n.promise=null,e}return n.conn}},43863:(e,t,r)=>{r.d(t,{Z:()=>n});var a=r(11185),i=r.n(a);let s=new a.Schema({title:{type:Map,of:String,required:!0},content:{type:Map,of:String,required:!0},excerpt:{type:Map,of:String,required:!0},author:{type:a.Schema.Types.ObjectId,ref:"User",required:!0},category:{type:String,enum:["first-time","food-culture","adventure","multi-city","budget","luxury"],required:!0},tags:[String],coverImage:{type:String,required:!0},images:[String],readTime:{type:Number,required:!0},views:{type:Number,default:0},likes:{type:Number,default:0},isPublished:{type:Boolean,default:!1},publishedAt:Date,itinerary:[{day:{type:Number,required:!0},title:{type:String,required:!0},description:{type:String,required:!0},activities:[String],accommodation:String,transportation:String,estimatedCost:Number}],relatedAttractions:[{type:a.Schema.Types.ObjectId,ref:"Attraction"}],seo:{metaTitle:String,metaDescription:String,keywords:[String]}},{timestamps:!0});s.index({category:1}),s.index({isPublished:1}),s.index({publishedAt:-1}),s.index({views:-1}),s.index({tags:1});let n=i().models.Guide||i().model("Guide",s)}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[276,972],()=>r(32475));module.exports=a})();